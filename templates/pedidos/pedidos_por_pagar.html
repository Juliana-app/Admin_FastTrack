{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}Pedidos por Pagar{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-center">💵 Pedidos Pendientes de Pago</h2>

{% if pedidos %}
    <div class="space-y-6">
        {% for pedido in pedidos %}
        <div class="bg-white p-6 rounded shadow border">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <p><strong>🧾 Pedido:</strong> #{{ pedido.id }}</p>
                    <p><strong>🍽️ Mesa:</strong> {{ pedido.mesa }}</p>
                    <p><strong>📅 Fecha:</strong> {{ pedido.creado|date:"d M Y H:i" }}</p>
                </div>
                <div>
                    <button onclick="confirmarPago('{{ pedido.id }}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        ✅ Marcar como Pagado
                    </button>
                </div>
            </div>

            <div>
                <p class="font-semibold mb-1">📦 Productos:</p>
                <ul class="list-disc ml-6 text-sm">
                    {% for item in pedido.productos.all %}
                        <li>{{ item.producto.nombre }} - Cantidad: {{ item.cantidad }} - Unitario: ${{ item.precio_unitario }} - Subtotal + IVA: ${{ item.subtotal_con_iva|floatformat:2 }}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="mt-4 text-right font-semibold text-lg">
                Total con IVA: ${{ pedido.productos.all|total_con_iva }}
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <p class="text-center text-gray-600">No hay pedidos pendientes de pago.</p>
{% endif %}

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmarPago(pedidoId) {
    Swal.fire({
        title: '¿Confirmar pago?',
        text: "Este pedido será marcado como pagado.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#16a34a',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sí, marcar como pagado'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/pedidos/marcar_pagado/' + pedidoId + '/';
        }
    });
}
</script>
{% endblock %}
