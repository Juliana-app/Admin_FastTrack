{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}Pedidos Pendientes{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/pedidos/ver_pedidos.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold mb-4">Pedidos Pendientes</h2>

<form method="get" action="{% url 'exportar_csv' %}" class="flex gap-2 mb-4">
    <input type="date" name="fecha_inicio" required class="border rounded px-2 py-1">
    <input type="date" name="fecha_fin" required class="border rounded px-2 py-1">
    <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
        ðŸ“¥ Exportar CSV
    </button>
</form>

<!-- BotÃ³n para abrir el modal de tomar pedido -->
<button id="abrirModal" class="tomar-pedido-btn">
    âž• Tomar Pedido
</button>

<!-- Tabla para mostrar los pedidos -->
<h3 class="text-xl font-semibold mt-6 mb-4">Pedidos Pendientes</h3>
<table class="min-w-full table-auto border-collapse">
    <thead>
        <tr>
            <th class="border px-4 py-2">ID</th>
            <th class="border px-4 py-2">Mesa</th>
            <th class="border px-4 py-2">Productos</th>
            <th class="border px-4 py-2">Fecha</th>
            <th class="border px-4 py-2">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for pedido in pedidos %}
        <tr>
            <td class="border px-4 py-2">{{ pedido.id }}</td>
            <td class="border px-4 py-2">{{ pedido.mesa.numeroMesa }} - {{ pedido.mesa.sede.nombre }}</td>
            <td class="border px-4 py-2">
                {% for producto in pedido.productos.all %}
                    {{ producto.nombre }} ({{ producto.cantidad }})<br>
                {% endfor %}
            </td>
            <td class="border px-4 py-2">{{ pedido.creado|date:"d M Y H:i"  }}</td>
            <td class="border px-4 py-2">
                <a href="{% url 'editar_pedido' pedido.id %}" class="text-yellow-500">Editar</a> |
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" class="border px-4 py-2 text-center">No hay pedidos pendientes.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Modal de tomar pedido -->
<div id="modalTomarPedido" class="modal">
    <div class="modal-contenido">
        <!-- BotÃ³n para cerrar el modal -->
        <span id="cerrarModal" class="cerrar">&times;</span>
        <h2 class="titulo-seccion">Tomar Pedido</h2>
        <form method="post" class="formulario-pedido">
            {% csrf_token %}
            <label>Mesa:</label>
            <select name="mesa_id" class="input-select" required>
                <option value="">-- Selecciona una mesa --</option>
                {% for mesa in mesas %}
                    <option value="{{ mesa.id }}">Mesa {{ mesa.numeroMesa }} - {{ mesa.sede.nombre }}</option>
                {% endfor %}
            </select>            
            <label>Productos:</label>
            <div id="productos-container">
                <div class="grupo-producto">
                    <select name="producto_id_1" class="input-select" required>
                        <option value="">-- Selecciona un producto --</option>
                        {% for inventario in productos %}
                        <option value="{{ inventario.producto.id }}">
                                {{ inventario.producto.nombre }} (Stock: {{ inventario.cantidad }})
                            </option>
                        {% endfor %}
                    </select>
                    <input type="number" name="cantidad_1" placeholder="Cantidad" class="input-texto" min="1" required>
                </div>
            </div>

            <button type="button" onclick="agregarProducto()" class="btn-agregar">âž• Agregar producto</button>
            <button type="submit" class="btn-guardar">Guardar Pedido</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>

// Mostrar el modal cuando se hace clic en el botÃ³n "Tomar Pedido"
document.getElementById("abrirModal").addEventListener("click", function() {
    const modal = document.getElementById("modalTomarPedido");
    modal.style.display = "block"; // AsegÃºrate de que el modal se muestra
    modal.classList.add("mostrar-modal"); // Agregar clase para mÃ¡s control
});

// Cerrar el modal cuando se hace clic en el botÃ³n de cierre
document.getElementById("cerrarModal").addEventListener("click", function() {
    const modal = document.getElementById("modalTomarPedido");
    modal.style.display = "none";  // Ocultar el modal
    modal.classList.remove("mostrar-modal"); // Eliminar la clase que muestra el modal
});

let contador = 2;
const productosOptions = 
    `<option value="">-- Selecciona un producto --</option>` +
    `{% for inventario in productos %}` +
        `<option value="{{ inventario.producto.id }}">{{ inventario.producto.nombre }} (Stock: {{ inventario.cantidad }})</option>` +
    `{% endfor %}`;

function agregarProducto() {
    const container = document.getElementById('productos-container');
    const div = document.createElement('div');
    div.classList.add('grupo-producto');
    div.innerHTML = 
        `<select name="producto_id_${contador}" class="input-select" required>` +
            `${productosOptions}` +
        `</select>` +
        `<input type="number" name="cantidad_${contador}" placeholder="Cantidad" class="input-texto" min="1" required>`;
    container.appendChild(div);
    contador++;
}

document.querySelector("form").addEventListener("submit", function (e) {
    e.preventDefault();
    const confirmed = confirm("Â¿EstÃ¡s seguro de guardar este pedido?");
    if (confirmed) {
        this.submit();
    }
});

</script>
{% endblock %}